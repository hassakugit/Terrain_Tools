<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Run Terrain Generator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .top-bar {
            background: rgba(255,255,255,0.1);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        
        .logo {
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .job-tracker-mini {
            background: rgba(255,255,255,0.2);
            border-radius: 6px;
            padding: 8px 12px;
            color: white;
            font-size: 0.9rem;
            display: none;
        }
        
        .job-tracker-mini.active {
            display: block;
        }
        
        .container {
            max-width: 1400px;
            margin: 20px auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        
        .header h1 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .cloud-run-info {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }
        
        .map-container {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }
        
        #map {
            width: 100%;
            height: 600px;
        }
        
        .controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
            max-height: 900px;
            overflow-y: auto;
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        .control-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }
        
        .control-group input,
        .control-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .button {
            width: 100%;
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 0;
            box-sizing: border-box;
        }
        
        .button:hover {
            background: #5a6fd8;
        }
        
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .button.cloud-run {
            background: #4285f4;
        }
        
        .button.cloud-run:hover {
            background: #3367d6;
        }
        
        .button.cancel {
            background: #dc3545;
        }
        
        .button.cancel:hover {
            background: #c82333;
        }
        
        .status {
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .progress-container {
            display: none;
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 2px solid #4285f4;
        }
        
        .progress-container.active {
            display: block;
        }
        
        .progress-bar {
            width: 100%;
            height: 15px;
            background: #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4285f4, #667eea);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-details {
            font-size: 0.9rem;
            color: #555;
            margin-top: 10px;
        }
        
        .job-manager {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .job-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .job-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .job-item.active {
            border-color: #4285f4;
            background: #f0f8ff;
        }
        
        .job-item.completed {
            border-color: #28a745;
            background: #f8fff9;
        }
        
        .job-item.failed {
            border-color: #dc3545;
            background: #fff8f8;
        }
        
        .job-info {
            flex: 1;
        }
        
        .job-actions {
            display: flex;
            gap: 5px;
        }
        
        .job-actions button {
            padding: 5px 10px;
            font-size: 0.8rem;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .selection-info {
            background: #e8f5e8;
            border: 1px solid #c3e6cb;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            display: none;
        }
        
        .time-estimate {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
            font-size: 0.9rem;
            color: #856404;
        }
        
        .download-section {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            display: none;
        }
        
        .download-section.active {
            display: block;
        }
        
        .download-link {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            text-decoration: none;
            margin: 5px;
            font-weight: bold;
        }
        
        .download-link:hover {
            background: #218838;
            color: white;
            text-decoration: none;
        }
        
        .range-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .range-group input[type="range"] {
            flex: 1;
        }
        
        .range-value {
            min-width: 50px;
            text-align: center;
            font-weight: bold;
            color: #667eea;
        }
        
        .api-key-group {
            margin-bottom: 20px;
        }
        
        .job-id-input {
            background: #f0f8ff;
            border: 1px solid #b3d9ff;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            #map {
                height: 400px;
            }
            
            .top-bar {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="logo">‚òÅÔ∏è Cloud Run Terrain Generator</div>
        <div class="job-tracker-mini" id="jobTrackerMini">
            <span id="activeJobText">No active jobs</span>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üåç Cloud Run Terrain Generator</h1>
            <p>Deploy once, process anywhere. Start jobs and close your browser!</p>
        </div>

        <div class="cloud-run-info">
            <strong>‚òÅÔ∏è Running on Google Cloud Run</strong><br>
            ‚úÖ Start jobs and close browser &nbsp;&nbsp;
            ‚úÖ 55-minute processing limit &nbsp;&nbsp;
            ‚úÖ Max 3000√ó3000 resolution &nbsp;&nbsp;
            ‚úÖ 7-day file storage
        </div>

        <!-- Job Manager Section -->
        <div class="job-manager">
            <h3>üìã Job Manager</h3>
            
            <div class="job-id-input">
                <label for="jobIdInput">Track Existing Job by ID:</label>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <input type="text" id="jobIdInput" placeholder="Enter job ID to track progress" style="flex: 1;">
                    <button class="button" onclick="trackJobById()" style="width: auto; padding: 8px 16px;">Track Job</button>
                </div>
            </div>
            
            <div id="jobList" class="job-list">
                <div class="status info">No jobs found. Create a new job below.</div>
            </div>
        </div>

        <div class="main-content">
            <div class="map-container">
                <div id="map"></div>
            </div>

            <div class="controls">
                <div class="api-key-group">
                    <div class="control-group">
                        <label for="googleKey">Google Maps API Key:</label>
                        <input type="password" id="googleKey" placeholder="Enter your Google Maps API key">
                    </div>
                    
                    <button class="button" onclick="loadMap()" id="loadBtn">Load Map</button>
                </div>

                <div class="selection-info" id="selectionInfo">
                    <strong>üìç Selected Area:</strong><br>
                    <span id="boundsText"></span><br>
                    <span id="areaText"></span>
                </div>

                <div class="control-group">
                    <label for="resolution">Resolution (Cloud Run Optimized):</label>
                    <select id="resolution" onchange="updateEstimates()">
                        <option value="500">500√ó500 (250K points) - ~5 min</option>
                        <option value="1000" selected>1000√ó1000 (1M points) - ~15 min</option>
                        <option value="1500">1500√ó1500 (2.25M points) - ~25 min</option>
                        <option value="2000">2000√ó2000 (4M points) - ~35 min</option>
                        <option value="2500">2500√ó2500 (6.25M points) - ~45 min</option>
                        <option value="3000">3000√ó3000 (9M points) - ~55 min (MAX)</option>
                    </select>
                </div>

                <div id="timeEstimate" class="time-estimate">
                    <strong>‚è±Ô∏è Cloud Run Estimate:</strong><br>
                    <span id="estimateText">~15 minutes for 1000√ó1000 resolution</span>
                </div>

                <div class="control-group">
                    <label for="exaggeration">Terrain Exaggeration: <span id="exagValue">2.0√ó</span></label>
                    <div class="range-group">
                        <input type="range" id="exaggeration" min="0.5" max="5" step="0.1" value="2" 
                               oninput="document.getElementById('exagValue').textContent = this.value + '√ó'">
                    </div>
                </div>

                <div class="control-group">
                    <label for="baseHeight">Base Height (mm):</label>
                    <input type="number" id="baseHeight" value="5" min="1" max="20">
                </div>

                <div class="control-group">
                    <label for="modelSize">Model Size (mm):</label>
                    <input type="number" id="modelSize" value="150" min="50" max="500">
                </div>

                <div class="progress-container" id="progressContainer">
                    <div><strong id="progressTitle">Cloud Run Processing...</strong></div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div id="progressText">Initializing...</div>
                    <div class="progress-details" id="progressDetails">
                        Processing on Cloud Run...
                    </div>
                </div>

                <div class="download-section" id="downloadSection">
                    <strong>üì• Download Your Model:</strong><br>
                    <div id="downloadContent"></div>
                </div>

                <button class="button cloud-run" id="generateBtn" onclick="startCloudRunJob()" disabled>
                    ‚òÅÔ∏è Start Cloud Run Job
                </button>

                <div id="status"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let map, rectangle, selectedBounds = null;
        let mapLoaded = false;
        let currentJobId = null;
        let jobStatusInterval = null;
        let trackedJobs = new Set();

        // Define all functions first
        function loadMap() {
            console.log('loadMap function called');
            const apiKey = document.getElementById('googleKey').value.trim();
            
            if (!apiKey) {
                showStatus('Please enter your Google Maps API key.', 'error');
                return;
            }

            showStatus('Loading Google Maps...', 'info');
            
            // Set up error handling for Google Maps
            window.gm_authFailure = function() {
                showStatus('‚ùå Google Maps API authentication failed. Check your API key and make sure Maps JavaScript API is enabled.', 'error');
            };
            
            // Remove any existing Google Maps scripts
            const existingScript = document.querySelector('script[src*="maps.googleapis.com"]');
            if (existingScript) {
                existingScript.remove();
            }
            
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=drawing&callback=initGoogleMap&v=weekly`;
            script.async = true;
            script.defer = true;
            
            script.onerror = function() {
                showStatus('‚ùå Failed to load Google Maps script. Check your internet connection and API key.', 'error');
            };
            
            // Timeout after 10 seconds
            const timeout = setTimeout(() => {
                showStatus('‚ùå Google Maps loading timeout. Please check your API key and try again.', 'error');
            }, 10000);
            
            window.initGoogleMap = function() {
                clearTimeout(timeout);
                initGoogleMapActual();
            };
            
            document.head.appendChild(script);
        }

        function initGoogleMapActual() {
            try {
                console.log('Initializing Google Maps...');
                
                // Check if Google Maps loaded properly
                if (typeof google === 'undefined' || !google.maps) {
                    throw new Error('Google Maps API not loaded properly');
                }
                
                showStatus('Google Maps loaded! Draw a rectangle to select terrain area.', 'success');
                mapLoaded = true;
                
                map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 10,
                    center: { lat: 34.6937, lng: 135.5023 }, // Osaka, Japan
                    mapTypeId: 'terrain',
                    gestureHandling: 'greedy'
                });

                // Wait for map to be fully loaded
                google.maps.event.addListenerOnce(map, 'idle', function() {
                    console.log('Map fully loaded and ready');
                    
                    const drawingManager = new google.maps.drawing.DrawingManager({
                        drawingMode: google.maps.drawing.OverlayType.RECTANGLE,
                        drawingControl: true,
                        drawingControlOptions: {
                            position: google.maps.ControlPosition.TOP_CENTER,
                            drawingModes: ['rectangle']
                        },
                        rectangleOptions: {
                            fillColor: '#4285f4',
                            fillOpacity: 0.3,
                            strokeWeight: 2,
                            strokeColor: '#4285f4',
                            editable: true
                        }
                    });

                    drawingManager.setMap(map);

                    drawingManager.addListener('rectanglecomplete', function(rect) {
                        console.log('Rectangle drawn');
                        if (rectangle) rectangle.setMap(null);
                        rectangle = rect;
                        selectedBounds = {
                            north: rect.getBounds().getNorthEast().lat(),
                            south: rect.getBounds().getSouthWest().lat(),
                            east: rect.getBounds().getNorthEast().lng(),
                            west: rect.getBounds().getSouthWest().lng()
                        };
                        updateSelectionInfo();
                        updateEstimates();
                        checkGenerateButton();

                        rect.addListener('bounds_changed', function() {
                            selectedBounds = {
                                north: rect.getBounds().getNorthEast().lat(),
                                south: rect.getBounds().getSouthWest().lat(),
                                east: rect.getBounds().getNorthEast().lng(),
                                west: rect.getBounds().getSouthWest().lng()
                            };
                            updateSelectionInfo();
                            updateEstimates();
                        });
                    });

                    document.getElementById('loadBtn').style.display = 'none';
                    showStatus('‚úÖ Map ready! Click the rectangle tool and draw an area to select terrain.', 'success');
                });

            } catch (error) {
                console.error('Google Maps initialization error:', error);
                showStatus('‚ùå Error initializing Google Maps: ' + error.message, 'error');
                
                // Provide helpful troubleshooting info
                setTimeout(() => {
                    showStatus('üí° Troubleshooting: 1) Check API key, 2) Enable Maps JavaScript API, 3) Enable Elevation API', 'info');
                }, 3000);
            }
        }

        function updateEstimates() {
            const resolution = parseInt(document.getElementById('resolution').value);
            const totalPoints = resolution * resolution;
            
            // Cloud Run optimized estimates
            const timeEstimates = {
                500: 5,
                1000: 15,
                1500: 25,
                2000: 35,
                2500: 45,
                3000: 55
            };
            
            const estimatedMinutes = timeEstimates[resolution] || Math.round(totalPoints / 20000);
            
            document.getElementById('estimateText').innerHTML = `
                <strong>~${estimatedMinutes} minutes</strong> for ${totalPoints.toLocaleString()} points<br>
                <small>Cloud Run optimized processing</small>
            `;
        }

        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.textContent = message;
        }

        function showProgress(show, progress = 0, text = '', details = '') {
            const container = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            
            if (show) {
                container.classList.add('active');
                progressFill.style.width = progress + '%';
                document.getElementById('progressText').textContent = text;
                if (details) {
                    document.getElementById('progressDetails').textContent = details;
                }
            } else {
                container.classList.remove('active');
            }
        }

        function updateJobTrackerMini() {
            const mini = document.getElementById('jobTrackerMini');
            const text = document.getElementById('activeJobText');
            
            if (currentJobId) {
                mini.classList.add('active');
                text.textContent = `Job: ${currentJobId.slice(0, 8)}...`;
            } else {
                mini.classList.remove('active');
                text.textContent = 'No active jobs';
            }
        }

        function updateSelectionInfo() {
            const info = document.getElementById('selectionInfo');
            if (selectedBounds) {
                const area = Math.abs(selectedBounds.north - selectedBounds.south) * 
                           Math.abs(selectedBounds.east - selectedBounds.west);
                
                document.getElementById('boundsText').innerHTML = 
                    `N: ${selectedBounds.north.toFixed(6)}, S: ${selectedBounds.south.toFixed(6)}<br>` +
                    `E: ${selectedBounds.east.toFixed(6)}, W: ${selectedBounds.west.toFixed(6)}`;
                
                let areaWarning = '';
                if (area > 0.1) areaWarning = '‚ö†Ô∏è Very large area - may hit 55min limit';
                else if (area > 0.01) areaWarning = '‚ö†Ô∏è Large area - monitor processing time';
                else areaWarning = '‚úÖ Good size for Cloud Run';
                
                document.getElementById('areaText').innerHTML = 
                    `Area: ${area.toFixed(6)} sq¬∞ - ${areaWarning}`;
                
                info.style.display = 'block';
            } else {
                info.style.display = 'none';
            }
        }

        function checkGenerateButton() {
            const btn = document.getElementById('generateBtn');
            const apiKey = document.getElementById('googleKey').value.trim();
            btn.disabled = !(mapLoaded && selectedBounds && apiKey && !currentJobId);
        }

        function trackJobById() {
            const jobId = document.getElementById('jobIdInput').value.trim();
            if (!jobId) {
                showStatus('Please enter a job ID.', 'error');
                return;
            }
            
            // Add to tracked jobs
            trackedJobs.add(jobId);
            saveTrackedJobs();
            
            // Start monitoring if not already current job
            if (currentJobId !== jobId) {
                currentJobId = jobId;
                startJobMonitoring(jobId);
                updateJobTrackerMini();
            }
            
            showStatus(`Now tracking job: ${jobId}`, 'info');
            updateJobList();
            document.getElementById('jobIdInput').value = '';
        }

        function startCloudRunJob() {
            if (!selectedBounds) {
                showStatus('Please select an area on the map first.', 'error');
                return;
            }

            const apiKey = document.getElementById('googleKey').value.trim();
            if (!apiKey) {
                showStatus('Please enter your Google Maps API key.', 'error');
                return;
            }

            const jobData = {
                bounds: selectedBounds,
                resolution: parseInt(document.getElementById('resolution').value),
                apiKey: apiKey,
                exaggeration: parseFloat(document.getElementById('exaggeration').value),
                baseHeight: parseFloat(document.getElementById('baseHeight').value),
                modelSize: parseFloat(document.getElementById('modelSize').value)
            };

            showStatus('Starting Cloud Run job...', 'info');

            fetch('/api/server-job', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(jobData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(error => {
                        throw new Error(error.error || 'Failed to start Cloud Run job');
                    });
                }
                return response.json();
            })
            .then(result => {
                currentJobId = result.jobId;
                
                // Add to tracked jobs
                trackedJobs.add(result.jobId);
                saveTrackedJobs();
                
                showStatus(`‚úÖ Cloud Run job started! Job ID: ${result.jobId}`, 'success');
                setTimeout(() => {
                    showStatus('üéâ You can now close your browser! The job will continue running.', 'success');
                }, 2000);
                
                // Start monitoring
                startJobMonitoring(result.jobId);
                updateJobList();
                updateJobTrackerMini();
                checkGenerateButton();
            })
            .catch(error => {
                showStatus('Error starting Cloud Run job: ' + error.message, 'error');
            });
        }

        function startJobMonitoring(jobId) {
            if (jobStatusInterval) {
                clearInterval(jobStatusInterval);
            }
            
            jobStatusInterval = setInterval(() => {
                checkJobStatus(jobId);
            }, 5000); // Check every 5 seconds
            
            // Also check immediately
            checkJobStatus(jobId);
        }

        function checkJobStatus(jobId) {
            fetch(`/api/job/${jobId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Job not found');
                }
                return response.json();
            })
            .then(job => {
                showProgress(true, job.progress, job.currentStep, 
                    `Cloud Run job: ${job.status} - ${job.progress}%`);
                
                if (job.status === 'completed') {
                    clearInterval(jobStatusInterval);
                    currentJobId = null;
                    updateJobTrackerMini();
                    showDownloadLinks(job);
                    showStatus(`üéâ Cloud Run job completed! File size: ${job.fileSize}`, 'success');
                    showProgress(false);
                    checkGenerateButton();
                } else if (job.status === 'failed') {
                    clearInterval(jobStatusInterval);
                    currentJobId = null;
                    updateJobTrackerMini();
                    showStatus(`‚ùå Cloud Run job failed: ${job.error}`, 'error');
                    showProgress(false);
                    checkGenerateButton();
                } else if (job.status === 'cancelled') {
                    clearInterval(jobStatusInterval);
                    currentJobId = null;
                    updateJobTrackerMini();
                    showStatus('Cloud Run job cancelled', 'warning');
                    showProgress(false);
                    checkGenerateButton();
                }
                
                updateJobList();
            })
            .catch(error => {
                console.error('Error checking job status:', error);
            });
        }

        function showDownloadLinks(job) {
            const section = document.getElementById('downloadSection');
            const content = document.getElementById('downloadContent');
            
            content.innerHTML = `
                <a href="/api/job/${job.id}/download" class="download-link" target="_blank">
                    üì• Download STL (${job.fileSize})
                </a>
                <br><small>File available for 7 days</small>
            `;
            
            section.classList.add('active');
        }

        function trackExistingJob(jobId) {
            currentJobId = jobId;
            startJobMonitoring(jobId);
            updateJobTrackerMini();
            checkGenerateButton();
            showStatus(`Now actively tracking job: ${jobId}`, 'info');
        }

        function removeJob(jobId) {
            trackedJobs.delete(jobId);
            saveTrackedJobs();
            
            if (currentJobId === jobId) {
                currentJobId = null;
                if (jobStatusInterval) {
                    clearInterval(jobStatusInterval);
                }
                updateJobTrackerMini();
                showProgress(false);
                checkGenerateButton();
            }
            
            updateJobList();
            showStatus(`Removed job: ${jobId.slice(0, 12)}...`, 'info');
        }

        function updateJobList() {
            const jobList = document.getElementById('jobList');
            
            if (trackedJobs.size === 0) {
                jobList.innerHTML = '<div class="status info">No jobs found. Create a new job below.</div>';
                return;
            }
            
            let jobsHtml = '';
            let jobPromises = [];
            
            for (const jobId of trackedJobs) {
                const promise = fetch(`/api/job/${jobId}`)
                    .then(response => {
                        if (response.ok) {
                            return response.json().then(job => ({job, jobId}));
                        } else {
                            return {job: null, jobId};
                        }
                    })
                    .catch(() => ({job: null, jobId}));
                
                jobPromises.push(promise);
            }
            
            Promise.all(jobPromises).then(results => {
                jobsHtml = '';
                
                for (const {job, jobId} of results) {
                    if (job) {
                        const isActive = currentJobId === jobId;
                        const statusClass = job.status === 'completed' ? 'completed' : 
                                          job.status === 'failed' ? 'failed' : 
                                          isActive ? 'active' : '';
                        
                        jobsHtml += `
                            <div class="job-item ${statusClass}">
                                <div class="job-info">
                                    <strong>${jobId.slice(0, 12)}...</strong><br>
                                    <small>${job.resolution}√ó${job.resolution} - ${job.status} (${job.progress}%)</small><br>
                                    <small>${job.currentStep}</small>
                                </div>
                                <div class="job-actions">
                                    ${job.status === 'completed' ? 
                                        `<a href="/api/job/${jobId}/download" style="background: #28a745; color: white; padding: 5px 10px; border-radius: 3px; text-decoration: none; font-size: 0.8rem;">Download</a>` :
                                        `<button onclick="trackExistingJob('${jobId}')" style="background: #4285f4; color: white;">Track</button>`
                                    }
                                    <button onclick="removeJob('${jobId}')" style="background: #dc3545; color: white;">Remove</button>
                                </div>
                            </div>
                        `;
                    } else {
                        jobsHtml += `
                            <div class="job-item">
                                <div class="job-info">
                                    <strong>${jobId.slice(0, 12)}...</strong><br>
                                    <small style="color: #dc3545;">Job not found</small>
                                </div>
                                <div class="job-actions">
                                    <button onclick="removeJob('${jobId}')" style="background: #dc3545; color: white;">Remove</button>
                                </div>
                            </div>
                        `;
                    }
                }
                
                jobList.innerHTML = jobsHtml;
            });
        }

        // Load jobs from localStorage
        function loadTrackedJobs() {
            try {
                const saved = localStorage.getItem('cloudRunJobs');
                if (saved) {
                    trackedJobs = new Set(JSON.parse(saved));
                    updateJobList();
                }
            } catch (error) {
                console.error('Error loading tracked jobs:', error);
                trackedJobs = new Set();
            }
        }

        // Save jobs to localStorage
        function saveTrackedJobs() {
            try {
                localStorage.setItem('cloudRunJobs', JSON.stringify([...trackedJobs]));
            } catch (error) {
                console.error('Error saving tracked jobs:', error);
            }
        }

        // Check for URL parameters on load (for sharing job links)
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const jobId = urlParams.get('job');
            
            if (jobId) {
                document.getElementById('jobIdInput').value = jobId;
                trackJobById();
                
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        function copyJobId(jobId) {
            navigator.clipboard.writeText(jobId).then(function() {
                showStatus('Job ID copied to clipboard!', 'success');
            }).catch(function() {
                showStatus('Failed to copy job ID', 'error');
            });
        }

        function shareJobLink(jobId) {
            const shareUrl = `${window.location.origin}${window.location.pathname}?job=${jobId}`;
            navigator.clipboard.writeText(shareUrl).then(function() {
                showStatus('Job tracking link copied to clipboard!', 'success');
            }).catch(function() {
                showStatus('Failed to copy job link', 'error');
            });
        }

        // Now assign all functions to window object after they're defined
        window.loadMap = loadMap;
        window.trackJobById = trackJobById;
        window.startCloudRunJob = startCloudRunJob;
        window.trackExistingJob = trackExistingJob;
        window.removeJob = removeJob;
        window.copyJobId = copyJobId;
        window.shareJobLink = shareJobLink;
        window.updateEstimates = updateEstimates;

        function updateSelectionInfo() {
            const info = document.getElementById('selectionInfo');
            if (selectedBounds) {
                const area = Math.abs(selectedBounds.north - selectedBounds.south) * 
                           Math.abs(selectedBounds.east - selectedBounds.west);
                
                document.getElementById('boundsText').innerHTML = 
                    `N: ${selectedBounds.north.toFixed(6)}, S: ${selectedBounds.south.toFixed(6)}<br>` +
                    `E: ${selectedBounds.east.toFixed(6)}, W: ${selectedBounds.west.toFixed(6)}`;
                
                let areaWarning = '';
                if (area > 0.1) areaWarning = '‚ö†Ô∏è Very large area - may hit 55min limit';
                else if (area > 0.01) areaWarning = '‚ö†Ô∏è Large area - monitor processing time';
                else areaWarning = '‚úÖ Good size for Cloud Run';
                
                document.getElementById('areaText').innerHTML = 
                    `Area: ${area.toFixed(6)} sq¬∞ - ${areaWarning}`;
                
                info.style.display = 'block';
            } else {
                info.style.display = 'none';
            }
        }

        function checkGenerateButton() {
            const btn = document.getElementById('generateBtn');
            const apiKey = document.getElementById('googleKey').value.trim();
            btn.disabled = !(mapLoaded && selectedBounds && apiKey && !currentJobId);
        }

        async function startCloudRunJob() {
            if (!selectedBounds) {
                showStatus('Please select an area on the map first.', 'error');
                return;
            }

            const apiKey = document.getElementById('googleKey').value.trim();
            if (!apiKey) {
                showStatus('Please enter your Google Maps API key.', 'error');
                return;
            }

            try {
                showStatus('Starting Cloud Run job...', 'info');
                
                const jobData = {
                    bounds: selectedBounds,
                    resolution: parseInt(document.getElementById('resolution').value),
                    apiKey: apiKey,
                    exaggeration: parseFloat(document.getElementById('exaggeration').value),
                    baseHeight: parseFloat(document.getElementById('baseHeight').value),
                    modelSize: parseFloat(document.getElementById('modelSize').value)
                };

                const response = await fetch('/api/server-job', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(jobData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to start Cloud Run job');
                }

                const result = await response.json();
                currentJobId = result.jobId;
                
                // Add to tracked jobs
                trackedJobs.add(result.jobId);
                saveTrackedJobs();
                
                showStatus(`‚úÖ Cloud Run job started! Job ID: ${result.jobId}`, 'success');
                showStatus('üéâ You can now close your browser! The job will continue running.', 'success');
                
                // Start monitoring
                startJobMonitoring(result.jobId);
                updateJobList();
                updateJobTrackerMini();
                checkGenerateButton();

            } catch (error) {
                showStatus('Error starting Cloud Run job: ' + error.message, 'error');
            }
        }

        function startJobMonitoring(jobId) {
            if (jobStatusInterval) {
                clearInterval(jobStatusInterval);
            }
            
            jobStatusInterval = setInterval(() => {
                checkJobStatus(jobId);
            }, 5000); // Check every 5 seconds
            
            // Also check immediately
            checkJobStatus(jobId);
        }

        async function checkJobStatus(jobId) {
            try {
                const response = await fetch(`/api/job/${jobId}`);
                if (!response.ok) {
                    throw new Error('Job not found');
                }
                
                const job = await response.json();
                
                showProgress(true, job.progress, job.currentStep, 
                    `Cloud Run job: ${job.status} - ${job.progress}%`);
                
                if (job.status === 'completed') {
                    clearInterval(jobStatusInterval);
                    currentJobId = null;
                    updateJobTrackerMini();
                    showDownloadLinks(job);
                    showStatus(`üéâ Cloud Run job completed! File size: ${job.fileSize}`, 'success');
                    showProgress(false);
                    checkGenerateButton();
                } else if (job.status === 'failed') {
                    clearInterval(jobStatusInterval);
                    currentJobId = null;
                    updateJobTrackerMini();
                    showStatus(`‚ùå Cloud Run job failed: ${job.error}`, 'error');
                    showProgress(false);
                    checkGenerateButton();
                } else if (job.status === 'cancelled') {
                    clearInterval(jobStatusInterval);
                    currentJobId = null;
                    updateJobTrackerMini();
                    showStatus('Cloud Run job cancelled', 'warning');
                    showProgress(false);
                    checkGenerateButton();
                }
                
                updateJobList();
                
            } catch (error) {
                console.error('Error checking job status:', error);
            }
        }

        function showDownloadLinks(job) {
            const section = document.getElementById('downloadSection');
            const content = document.getElementById('downloadContent');
            
            content.innerHTML = `
                <a href="/api/job/${job.id}/download" class="download-link" target="_blank">
                    üì• Download STL (${job.fileSize})
                </a>
                <br><small>File available for 7 days</small>
            `;
            
            section.classList.add('active');
        }

        function trackJobById() {
            const jobId = document.getElementById('jobIdInput').value.trim();
            if (!jobId) {
                showStatus('Please enter a job ID.', 'error');
                return;
            }
            
            // Add to tracked jobs
            trackedJobs.add(jobId);
            saveTrackedJobs();
            
            // Start monitoring if not already current job
            if (currentJobId !== jobId) {
                currentJobId = jobId;
                startJobMonitoring(jobId);
                updateJobTrackerMini();
            }
            
            showStatus(`Now tracking job: ${jobId}`, 'info');
            updateJobList();
            document.getElementById('jobIdInput').value = '';
        }

        async function updateJobList() {
            const jobList = document.getElementById('jobList');
            
            if (trackedJobs.size === 0) {
                jobList.innerHTML = '<div class="status info">No jobs found. Create a new job below.</div>';
                return;
            }
            
            let jobsHtml = '';
            
            for (const jobId of trackedJobs) {
                try {
                    const response = await fetch(`/api/job/${jobId}`);
                    if (response.ok) {
                        const job = await response.json();
                        const isActive = currentJobId === jobId;
                        const statusClass = job.status === 'completed' ? 'completed' : 
                                          job.status === 'failed' ? 'failed' : 
                                          isActive ? 'active' : '';
                        
                        jobsHtml += `
                            <div class="job-item ${statusClass}">
                                <div class="job-info">
                                    <strong>${jobId.slice(0, 12)}...</strong><br>
                                    <small>${job.resolution}√ó${job.resolution} - ${job.status} (${job.progress}%)</small><br>
                                    <small>${job.currentStep}</small>
                                </div>
                                <div class="job-actions">
                                    ${job.status === 'completed' ? 
                                        `<a href="/api/job/${jobId}/download" style="background: #28a745; color: white; padding: 5px 10px; border-radius: 3px; text-decoration: none; font-size: 0.8rem;">Download</a>` :
                                        `<button onclick="trackExistingJob('${jobId}')" style="background: #4285f4; color: white;">Track</button>`
                                    }
                                    <button onclick="removeJob('${jobId}')" style="background: #dc3545; color: white;">Remove</button>
                                </div>
                            </div>
                        `;
                    } else {
                        // Job not found, mark for removal
                        jobsHtml += `
                            <div class="job-item">
                                <div class="job-info">
                                    <strong>${jobId.slice(0, 12)}...</strong><br>
                                    <small style="color: #dc3545;">Job not found</small>
                                </div>
                                <div class="job-actions">
                                    <button onclick="removeJob('${jobId}')" style="background: #dc3545; color: white;">Remove</button>
                                </div>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Error fetching job:', error);
                }
            }
            
            jobList.innerHTML = jobsHtml;
        }

        function trackExistingJob(jobId) {
            currentJobId = jobId;
            startJobMonitoring(jobId);
            updateJobTrackerMini();
            checkGenerateButton();
            showStatus(`Now actively tracking job: ${jobId}`, 'info');
        }

        function removeJob(jobId) {
            trackedJobs.delete(jobId);
            saveTrackedJobs();
            
            if (currentJobId === jobId) {
                currentJobId = null;
                if (jobStatusInterval) {
                    clearInterval(jobStatusInterval);
                }
                updateJobTrackerMini();
                showProgress(false);
                checkGenerateButton();
            }
            
            updateJobList();
            showStatus(`Removed job: ${jobId.slice(0, 12)}...`, 'info');
        }

        // Check for URL parameters on load (for sharing job links)
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const jobId = urlParams.get('job');
            
            if (jobId) {
                document.getElementById('jobIdInput').value = jobId;
                trackJobById();
                
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // Initialize everything
        document.addEventListener('DOMContentLoaded', function() {
            updateEstimates();
            loadTrackedJobs();
            checkUrlParams();
            
            // Check for changes in API key
            document.getElementById('googleKey').addEventListener('input', checkGenerateButton);
            
            // Auto-refresh job list every 30 seconds
            setInterval(updateJobList, 30000);
            
            showStatus('Enter your Google Maps API key and load the map to get started.', 'info');
        });

        // Keep the page alive to maintain job monitoring
        setInterval(async () => {
            try {
                await fetch('/api/keepalive');
            } catch (error) {
                console.log('Keep-alive ping failed');
            }
        }, 5 * 60 * 1000); // Every 5 minutes

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && currentJobId) {
                // Page became visible, refresh job status
                checkJobStatus(currentJobId);
            }
        });

        // Copy job ID to clipboard
        function copyJobId(jobId) {
            navigator.clipboard.writeText(jobId).then(function() {
                showStatus('Job ID copied to clipboard!', 'success');
            }).catch(function() {
                showStatus('Failed to copy job ID', 'error');
            });
        }

        // Share job link
        function shareJobLink(jobId) {
            const shareUrl = `${window.location.origin}${window.location.pathname}?job=${jobId}`;
            navigator.clipboard.writeText(shareUrl).then(function() {
                showStatus('Job tracking link copied to clipboard!', 'success');
            }).catch(function() {
                showStatus('Failed to copy job link', 'error');
            });
        }